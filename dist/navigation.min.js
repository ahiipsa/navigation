!function(){function scroll(scrollContainer,currentElement,nextElement){var scrollLeft=nextElement.offsetLeft+nextElement.offsetWidth/2-scrollContainer.offsetWidth/2,scrollTop=nextElement.offsetTop+nextElement.offsetHeight/2-scrollContainer.offsetHeight/2;scrollContainer.scrollLeft=scrollLeft,scrollContainer.scrollTop=scrollTop}function getElementsByAttributeName(elements,attribute){for(var result=[],i=0,n=elements.length;n>i;i++)if(null!==elements[i].getAttribute(attribute)&&result.push(elements[i]),elements[i].children.length>0){var childrens=getElementsByAttributeName(elements[i].children,attribute);childrens.length>0&&(result=result.concat(childrens))}return result}function addClass(element,className){removeClass(element,className),element.className=element.className.split(" ").concat([className]).join(" ").trim()}function removeClass(element,className){for(var classes=element.className.split(" "),i=classes.length-1;i>=0;i--)classes[i]==className&&classes.splice(i,1);element.className=classes.join(" ")}function mergeObjects(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3}function clone(obj){if(null==obj||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy}var prefix="nv",options={FOV:35,attr:prefix,attrScope:prefix+"-scope",attrScopeCurrent:prefix+"-scope-current",attrElement:prefix+"-el",attrElementCurrent:prefix+"-el-current"},Nav=function(){this.isMouseEnable=!0,this.mouseEnableTimeout=!0,this._scopes={},this._currentScope=null,this._prevScope=null,this.keyMapping={37:"left",38:"up",39:"right",40:"down",13:"enter",27:"back",403:"red",404:"green",405:"yellow",406:"blue",412:"rw",413:"stop",415:"play",417:"ff",33:"ch_up",34:"ch_down",457:"info",461:"back",1015:"mic",4:"left",5:"right",29460:"up",29461:"down",29443:"enter"}};Nav.prototype.initialize=function(){var self=this,body=document.body,navElements=getElementsByAttributeName(body.children,options.attrElement);return body.addEventListener("keydown",self),navElements.forEach(function(element){self.addElement(element)}),!this.getCurrentScope(),this},Nav.prototype.refresh=function(){this.deinitialize(),this.initialize()},Nav.prototype.deinitialize=function(){this._scopes={},this._currentScope=null,this._prevScope=null,document.body.removeEventListener("keydown",self)},Nav.prototype.getOptions=function(){var opt=clone(options);return opt},Nav.prototype.getKeyMapping=function(){return this.keyMapping},Nav.prototype.setKeyMapping=function(keyMapping){return this.keyMapping=keyMapping,this},Nav.prototype.addKeyMapping=function(keyMapping){return this.keyMapping=mergeObjects(this.keyMapping,keyMapping),this},Nav.prototype.addScope=function(element){var self=this,navScope=new NavScope(element);self._scopes[navScope.name]=navScope;var attrCurrentScope=element.getAttribute(options.attrScopeCurrent);(""===attrCurrentScope||"true"===attrCurrentScope)&&self.setCurrentScope(navScope);var _remove=element.remove;return element.remove=function(){self.removeScope(element),_remove.call(element)},addClass(element,options.attrScope),self},Nav.prototype.removeScope=function(scope){var scopeName="";"string"==typeof scope&&(scopeName=scope),"object"==typeof scope&&(scopeName=scope.getAttribute(options.attrScope)),this.getScopes()[scopeName]=null},Nav.prototype.isCurrentScope=function(scope){return scope===this.getCurrentScope()?!0:!1},Nav.prototype.changeScope=function(scopeName){var scope=this.getScopes()[scopeName];if(!scope)throw new Error("Scope not found");return this.setCurrentScope(scope),scope.activate(),this},Nav.prototype.getPrevScope=function(){return this._prevScope?this._prevScope:!1},Nav.prototype.getCurrentScope=function(){return this._currentScope?this._currentScope:!1},Nav.prototype.setCurrentScope=function(scope){this._prevScope=this.getCurrentScope();var prevElement=null;if(this._prevScope){prevElement=this._prevScope.getCurrentElement();var prevScopeEl=this._prevScope.getScopeElement();prevScopeEl.removeAttribute(options.attrScopeCurrent),removeClass(prevScopeEl,options.attrScopeCurrent),prevElement&&removeClass(this._prevScope.getCurrentElement(),options.attrElementCurrent)}return this._currentScope=scope,addClass(scope.getScopeElement(),options.attrScopeCurrent),scope.getScopeElement().setAttribute(options.attrScopeCurrent,"true"),this},Nav.prototype.getScopes=function(){return this._scopes},Nav.prototype.getEventName=function(event){return"undefined"!=typeof this.keyMapping[event.keyCode]?this.keyMapping[event.keyCode]:!1},Nav.prototype.getScope=function(scopeName){var scope=this.getScopes()[scopeName];return scope?scope:!1},Nav.prototype.getCurrentElement=function(){return this.getCurrentScope().getCurrentElement()},Nav.prototype.addElementToScope=function(scopeName,element){var self=this,scope=this.getScope(scopeName);if(!scope)throw Error('Scope "'+scopeName+'" not found');scope.addElement(element),element.setAttribute("tabindex",(scope.getNavigationElements().length+1).toString());var _remove=element.remove;return element.remove=function(){console.log("----  remove element"),scope.removeElement(element),_remove.call(element)},scope.isCurrentElement(element)&&scope.setCurrentElement(element),element.addEventListener("mouseover",function(event){return self.isMouseEnable?(scope.isCurrentElement(element)||scope.setCurrentElement(element),void(self.isCurrentScope(scope)||self.changeScope(scope.name))):!1}),self},Nav.prototype.addElement=function(element){for(var scopeName=null,_el=element,attrName=options.attrScope;null===scopeName&&null!==_el.parentElement;)scopeName=_el.parentElement.getAttribute(attrName),_el=_el.parentElement;if(!scopeName)throw new Error(element+" not belong to scope");var scope=this.getScope(scopeName);scope||this.addScope(_el),this.addElementToScope(scopeName,element),addClass(element,options.attrElement)},Nav.prototype.handleEvent=function(event){this.onKeyDown(event)},Nav.prototype.onKeyDown=function(event){var self=this,currentScope=self.getCurrentScope();if(!currentScope)return void console.error("current scope not found");var currentElement=currentScope.getCurrentElement();if(currentElement){var eventName=this.getEventName(event),nextElement=null;eventName&&["left","right","up","down"].indexOf(eventName)>-1&&(nextElement=currentScope.getNextElement(eventName),nextElement&&(currentScope.setCurrentElement(nextElement),this.trigger("move",currentElement)),self.mouseEnableTimeout&&clearTimeout(self.mouseEnableTimeout),self.isMouseEnable=!1,self.mouseEnableTimeout=setTimeout(function(){self.isMouseEnable=!0},1e3)),eventName&&this.trigger(eventName,currentElement);var log=document.getElementById("nav-event-info");log&&(log.innerHTML="<b>Last event:</b><br /> navEvent: "+options.prefix+"-"+eventName+"<br /> keyValue: "+String.fromCharCode(event.keyCode||event.charCode)+"<br /> keyCode: "+event.keyCode+"<br /> eventType: "+event.type+"<br /> navScope: "+currentScope.name)}},Nav.prototype.trigger=function(eventName,target){var navEvent=new Event(prefix+"-"+eventName,{bubbles:!0,cancelable:!1,target:target,toElement:target});target.dispatchEvent(navEvent)};var NavScope=function(element){var self=this;return self.name=element.getAttribute(options.attrScope),self.element=element,self.navigationElements=[],self.currentElement=null,self.activate(),self};NavScope.prototype.activate=function(){return console.log(this.name,": activated, elements",this.navigationElements.length),this.currentElement=this.getCurrentElement(),!this.currentElement,this.currentElement&&addClass(this.currentElement,options.attrElementCurrent),this},NavScope.prototype.addElement=function(element){return this.navigationElements.indexOf(element)>-1?this:(this.navigationElements.push(element),this)},NavScope.prototype.removeElement=function(element){var index=this.navigationElements.indexOf(element);return this.isCurrentElement(element),index>-1&&this.navigationElements.splice(index,1),this},NavScope.prototype.getScopeElement=function(){return this.element?this.element:!1},NavScope.prototype.getCurrentElement=function(){if(this.currentElement)return this.currentElement;for(var navElements=this.navigationElements,currentElement=!1,i=0,n=navElements.length;n>i;i++)this.isCurrentElement(navElements[i])&&(currentElement=navElements[i]);return currentElement},NavScope.prototype.getNavigationElements=function(){return this.navigationElements},NavScope.prototype.isCurrentElement=function(element){var attr=element.getAttribute(options.attrElementCurrent);return""===attr||"true"===attr?!0:!1},NavScope.prototype.setCurrentElement=function(element){var prevElement=this.getCurrentElement();this.currentElement=element,prevElement&&(prevElement.removeAttribute(options.attrElementCurrent),removeClass(prevElement,options.attrElementCurrent)),this.currentElement=element,addClass(this.currentElement,options.attrElementCurrent),this.currentElement.setAttribute(options.attrElementCurrent,"true")},NavScope.prototype.getNextElement=function(direction){var current=this.getCurrentElement();if(current){for(var index,distance=null,navElements=this.navigationElements,currentRect=current.getBoundingClientRect(),cx=currentRect.left+currentRect.width/2,cy=currentRect.top+currentRect.height/2,FOV=options.FOV,i=0;i<navElements.length;i++){var el=navElements[i],isHidden=null==el.offsetParent,isCurrent=navElements.indexOf(current)==i,inDOM=document.body.contains(el);if(!isHidden&&!isCurrent&&inDOM){var elRect=el.getBoundingClientRect(),ex=elRect.left+elRect.width/2,ey=elRect.top+elRect.height/2,xdiff=cx-ex,ydiff=cy-ey,dis=Math.round(Math.pow(xdiff*xdiff+ydiff*ydiff,.5)),angle=Math.round(Math.atan2(ydiff,xdiff)*(180/Math.PI));0>angle&&(angle+=360);var inFOV=!1;"left"==direction&&(angle>360-FOV&&360>=angle||angle>=0&&0+FOV>angle)?inFOV=!0:"down"==direction&&angle>270-FOV&&270+FOV>angle?inFOV=!0:"right"==direction&&angle>180-FOV&&180+FOV>angle?inFOV=!0:"up"==direction&&angle>90-FOV&&90+FOV>angle&&(inFOV=!0),inFOV&&(null===distance||distance>dis)&&(distance=dis,index=i)}}if("undefined"==typeof index)return!1;var nextElement=navElements[index];return scroll(this.element,current,nextElement),nextElement}};var nav=new Nav;window.navigation=function(){return nav.initialize()}()}();