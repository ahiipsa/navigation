!function(){function scroll(scrollContainer,element){var scrollLeft=element.offsetLeft+element.offsetWidth/2-scrollContainer.offsetWidth/2,scrollTop=element.offsetTop+element.offsetHeight/2-scrollContainer.offsetHeight/2;scrollContainer.scrollLeft=scrollLeft,scrollContainer.scrollTop=scrollTop}function getElementsByAttributeName(elements,attribute){for(var result=[],i=0,n=elements.length;n>i;i++)if(null!==elements[i].getAttribute(attribute)&&result.push(elements[i]),elements[i].children.length>0){var childrens=getElementsByAttributeName(elements[i].children,attribute);childrens.length>0&&(result=result.concat(childrens))}return result}function addClass(element,className){removeClass(element,className),element.className=element.className.split(" ").concat([className]).join(" ").trim()}function removeClass(element,className){for(var classes=element.className.split(" "),i=classes.length-1;i>=0;i--)classes[i]==className&&classes.splice(i,1);element.className=classes.join(" ")}function clone(obj){if(null==obj||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy}function Point(x,y){this.x=x,this.y=y}function Point2f(start,type,end){return"-"==type?{x:start.x-end.x,y:start.y-end.y}:"*"==type?{x:start.x*end.x,y:start.y*end.y}:"+"==type?{x:start.x+end.x,y:start.y+end.y}:"/"==type?{x:start.x/end.x,y:start.y/end.y}:void 0}function getIntersection(start1,end1,start2,end2){var dir1=Point2f(end1,"-",start1),dir2=Point2f(end2,"-",start2),a1=-dir1.y,b1=+dir1.x,d1=-(a1*start1.x+b1*start1.y),a2=-dir2.y,b2=+dir2.x,d2=-(a2*start2.x+b2*start2.y),seg1_line2_start=a2*start1.x+b2*start1.y+d2,seg1_line2_end=a2*end1.x+b2*end1.y+d2,seg2_line1_start=a1*start2.x+b1*start2.y+d1,seg2_line1_end=a1*end2.x+b1*end2.y+d1;if(seg1_line2_start*seg1_line2_end>=0||seg2_line1_start*seg2_line1_end>=0)return!1;var u=seg1_line2_start/(seg1_line2_start-seg1_line2_end),pin_out=Point2f({x:u,y:u},"*",dir1);return Point2f(start1,"+",pin_out)}function getAngle(pointA,pointB){var diff=Point2f(pointA,"-",pointB),angle=Math.round(Math.atan2(diff.y,diff.x)*(180/Math.PI));return angle}function getDistance(pointA,pointB){var diff=Point2f(pointA,"-",pointB),dis=Math.round(Math.pow(diff.x*diff.x+diff.y*diff.y,.5));return dis}function getWindowSize(){var w=window,d=document,e=d.documentElement,g=d.getElementsByTagName("body")[0],width=w.innerWidth||e.clientWidth||g.clientWidth,height=w.innerHeight||e.clientHeight||g.clientHeight;return{width:width,height:height}}if("undefined"==typeof DEBUG)var DEBUG=!1;var prefix="nv",options={FOV:90,prefix:prefix,attr:prefix,attrScope:prefix+"-scope",attrScopeFOV:prefix+"-scope-fov",attrScopeCurrent:prefix+"-scope-current",attrElement:prefix+"-el",attrElementFOV:prefix+"-el-fov",attrElementCurrent:prefix+"-el-current"},Nav=function(){return Nav.instance?Nav.instance:(Nav.instance=this,Nav.instance)};Nav.prototype.debug=function(flag){return DEBUG=flag},Nav.prototype.isMouseEnable=!0,Nav.prototype.mouseEnableTimeout=!0,Nav.prototype._scopes={},Nav.prototype._currentScope=null,Nav.prototype._prevScope=null,Nav.prototype._keyMapping=[[37,"left"],[38,"up"],[39,"right"],[40,"down"],[13,"enter"],[27,"back"],[403,"red"],[404,"green"],[405,"yellow"],[406,"blue"],[412,"rw"],[413,"stop"],[415,"play"],[417,"ff"],[33,"ch_up"],[34,"ch_down"],[457,"info"],[48,"numpad",0],[49,"numpad",1],[50,"numpad",2],[51,"numpad",3],[52,"numpad",4],[53,"numpad",5],[54,"numpad",6],[55,"numpad",7],[56,"numpad",8],[57,"numpad",9],[461,"back"],[1015,"mic"],[4,"left"],[5,"right"],[29460,"up"],[29461,"down"],[29443,"enter"],[108,"red"],[20,"green"],[21,"yellow"],[22,"blue"],[69,"rw"],[71,"play"],[74,"pause"],[72,"ff"],[7,"volume_up"],[11,"volume_down"],[68,"ch_up"],[65,"ch_down"],[70,"stop"],[27,"mute"],[31,"info"],[88,"back"],[17,"numpad",0],[101,"numpad",1],[98,"numpad",2],[6,"numpad",3],[8,"numpad",4],[9,"numpad",5],[10,"numpad",6],[12,"numpad",7],[13,"numpad",8],[14,"numpad",9]],Nav.prototype.initialize=function(){var self=this,body=document.body,navElements=getElementsByAttributeName(body.children,options.attrElement);return body.addEventListener("keydown",self),navElements.forEach(function(element){self.addElement(element)}),this.getCurrentScope()||DEBUG&&console.log("not found current scope"),this},Nav.prototype.deinitialize=function(){var self=this;this._scopes={},this._currentScope=null,this._prevScope=null,document.body.removeEventListener("keydown",self)},Nav.prototype.refresh=function(){this.deinitialize(),this.initialize()},Nav.prototype.getOptions=function(){var opt=clone(options);return opt},Nav.prototype.setOption=function(key,value){return options[key]=value,this},Nav.prototype.getKeyMapping=function(){return this._keyMapping},Nav.prototype.setKeyMapping=function(keyMapping){return this._keyMapping=keyMapping,this},Nav.prototype.addKeyMapping=function(keyMapping){return this._keyMapping=this._keyMapping.concat(keyMapping),this},Nav.prototype.addScope=function(element){var self=this,navScope=new NavScope(element);self._scopes[navScope.name]=navScope;var attrCurrentScope=element.getAttribute(options.attrScopeCurrent);(""===attrCurrentScope||"true"===attrCurrentScope)&&(DEBUG&&console.info(navScope.name,": is current scope"),self.setCurrentScope(navScope));var _remove=element.remove;return element.remove=function(){self.removeScope(element),_remove.call(element)},addClass(element,options.attrScope),self},Nav.prototype.removeScope=function(scope){var scopeName="";"string"==typeof scope&&(scopeName=scope),"object"==typeof scope&&(scopeName=scope.getAttribute(options.attrScope)),scope=this.getScope(scopeName),this.isCurrentScope(scope)&&(DEBUG&&console.log("remove current scope"),this._currentScope=null),DEBUG&&console.log("remove scope",scopeName),this.getScopes()[scopeName]=void 0,delete this.getScopes()[scopeName]},Nav.prototype.removeElement=function(element){for(var scopes=this.getScopes(),i=0;i<scopes.length;i++)scopes[i].removeElement(element);return this},Nav.prototype.isCurrentScope=function(scope){return scope===this.getCurrentScope()?!0:!1},Nav.prototype.changeScope=function(scopeName){var scope=this.getScope(scopeName);if(!scope)throw new Error("Scope not found");return this.setCurrentScope(scope),this},Nav.prototype.getPrevScope=function(){return this._prevScope?this._prevScope:!1},Nav.prototype.getCurrentScope=function(){return this._currentScope?this._currentScope:!1},Nav.prototype.setCurrentScope=function(scope){var prevScope=this.getCurrentScope(),prevElement=null;if(prevScope.name===scope.name)return DEBUG&&console.info(scope.name,": scope is current now"),this;if(this._prevScope=prevScope,this._prevScope){prevElement=this._prevScope.getCurrentElement();var prevScopeEl=this._prevScope.getScopeElement();prevScopeEl.removeAttribute(options.attrScopeCurrent),removeClass(prevScopeEl,options.attrScopeCurrent),prevElement&&removeClass(prevElement,options.attrElementCurrent)}return this._currentScope=scope,addClass(scope.getScopeElement(),options.attrScopeCurrent),scope.getScopeElement().setAttribute(options.attrScopeCurrent,"true"),scope.activate(),this},Nav.prototype.getScopes=function(){return this._scopes},Nav.prototype.getEventName=function(event){for(var keyMapping=this.getKeyMapping(),i=0;i<keyMapping.length;i++){var item=keyMapping[i];if(item[0]==event.keyCode)return item[1]}return!1},Nav.prototype.getEventValue=function(event){for(var keyMapping=this.getKeyMapping(),i=0;i<keyMapping.length;i++){var item=keyMapping[i];if(item[0]==event.keyCode)return"undefined"==typeof item[2]?item[1]:item[2]}return!1},Nav.prototype.getScope=function(scopeName){var scope=this.getScopes()[scopeName];return scope?scope:!1},Nav.prototype.isScopeExist=function(scopeName){var scope=this.getScope(scopeName);return scope?!0:!1},Nav.prototype.getCurrentElement=function(){return this.getCurrentScope().getCurrentElement()},Nav.prototype.addElementToScope=function(scopeName,element){var self=this,scope=this.getScope(scopeName);if(!scope)throw Error('Scope "'+scopeName+'" not found');DEBUG&&console.info(scope.name,": add new element"),scope.addElement(element),element.setAttribute("tabindex",(scope.getNavigationElements().length+1).toString());var _remove=element.remove;return element.remove=function(){DEBUG&&console.log("----  remove element"),scope.removeElement(element),_remove.call(element)},scope.isCurrentElement(element)&&(DEBUG&&console.info(scope.name,": new element is current"),scope.setCurrentElement(element)),element.addEventListener("mouseover",function(event){return self.isMouseEnable?(scope.isCurrentElement(element)||scope.setCurrentElement(element),self.isCurrentScope(scope)||self.changeScope(scope.name),void scope.setCurrentElement(element)):!1}),self},Nav.prototype.addElement=function(element){for(var scopeName=null,_el=element,attrName=options.attrScope;null===scopeName&&null!==_el.parentElement;)scopeName=_el.parentElement.getAttribute(attrName),_el=_el.parentElement;if(!scopeName)throw new Error(element+" not belong to scope");var scope=this.getScope(scopeName);scope||this.addScope(_el),this.addElementToScope(scopeName,element),addClass(element,options.attrElement)},Nav.prototype.handleEvent=function(event){this.onKeyDown(event)},Nav.prototype.onKeyDown=function(event){var self=this,currentScope=self.getCurrentScope();if(!currentScope)return void(DEBUG&&console.error("current scope not found"));var currentElement=currentScope.getCurrentElement();if(!currentElement)return void(DEBUG&&console.info("current element not found"));var eventName=this.getEventName(event),eventValue=this.getEventValue(event);eventName&&["left","right","up","down"].indexOf(eventName)>-1&&self.move(eventName),eventName&&this.trigger(eventName,currentElement,eventValue);var log=document.getElementById("nav-event-info");log&&(log.innerHTML="<b>Last event:</b><br /> navEvent: "+options.prefix+"-"+eventName+"<br /> keyValue: "+String.fromCharCode(event.keyCode||event.charCode)+"<br /> eventValue: "+eventValue+"<br /> keyCode: "+event.keyCode+"<br /> eventType: "+event.type+"<br /> navScope: "+currentScope.name)},Nav.prototype.move=function(direction){var self=this,currentScope=self.getCurrentScope(),currentElement=currentScope.getCurrentElement(),nextElement=currentScope.getNextElement(direction);nextElement&&(currentScope.setCurrentElement(nextElement),this.trigger("move",currentElement)),self.mouseEnableTimeout&&clearTimeout(self.mouseEnableTimeout),self.isMouseEnable=!1,self.mouseEnableTimeout=setTimeout(function(){self.isMouseEnable=!0},1e3)},Nav.prototype.trigger=function(name,target,value){var eventName=options.prefix+"-"+name,navEvent=null;if("function"==typeof CustomEvent)navEvent=new CustomEvent(eventName,{bubbles:"true",detail:{value:value}});else{if("function"!=typeof document.createEvent)throw DEBUG&&console.log("Can	 create custom event"),new Error("Can	 create custom event");navEvent=document.createEvent("CustomEvent"),navEvent.initCustomEvent(eventName,!0,!0,{value:value})}target.dispatchEvent(navEvent)},Nav.prototype.scrollToCurrentElement=function(){var scope=this.getCurrentScope(),element=scope.getCurrentElement();scroll(scope.element,element)};var NavScope=function(element){var self=this;return self.name=element.getAttribute(options.attrScope),DEBUG&&console.info(self.name,": scope create"),self.element=element,self.navigationElements=[],self.currentElement=null,self.activate(),self.FOV=parseInt(element.getAttribute(options.attrScopeFOV),10),self};NavScope.prototype.activate=function(){return DEBUG&&console.log(this.name,": activated, elements",this.navigationElements.length),this.currentElement=this.getCurrentElement(),this.currentElement?addClass(this.currentElement,options.attrElementCurrent):DEBUG&&console.info(this.name,": not found current element"),this},NavScope.prototype.addElement=function(element){return this.navigationElements.indexOf(element)>-1?this:(this.navigationElements.push(element),this)},NavScope.prototype.removeElement=function(element){var index=this.navigationElements.indexOf(element);return this.isCurrentElement(element)&&DEBUG&&console.info("remove current element"),index>-1&&this.navigationElements.splice(index,1),this},NavScope.prototype.getScopeElement=function(){return this.element?this.element:!1},NavScope.prototype.getCurrentElement=function(){if(this.currentElement)return this.currentElement;for(var navElements=this.navigationElements,currentElement=!1,i=0,n=navElements.length;n>i;i++)this.isCurrentElement(navElements[i])&&(currentElement=navElements[i]);return currentElement},NavScope.prototype.getNavigationElements=function(){return this.navigationElements},NavScope.prototype.isCurrentElement=function(element){var attr=element.getAttribute(options.attrElementCurrent);return""===attr||"true"===attr?!0:!1},NavScope.prototype.setCurrentElement=function(element){var prevElement=this.getCurrentElement();this.currentElement=element,prevElement&&this.cleanCurrentElement(prevElement),this.currentElement=element,addClass(this.currentElement,options.attrElementCurrent),this.currentElement.setAttribute(options.attrElementCurrent,"true")},NavScope.prototype.cleanCurrentElement=function(element){element.removeAttribute(options.attrElementCurrent),removeClass(element,options.attrElementCurrent)},NavScope.prototype.getNextElement=function(direction){var current=this.getCurrentElement();if(!current)return DEBUG&&console.info("Current element not found"),!1;if(-1===["up","down","left","right"].indexOf(direction)){var error="Not declared direction: "+direction;throw DEBUG&&console.error(error),Error(error)}var index,windowSize=getWindowSize(),currentElementFOV=parseInt(current.getAttribute(options.attrElementFOV),10),FOV=currentElementFOV||this.FOV||options.FOV,halfFOV=FOV/2,distance=null,navElements=this.navigationElements,currentElementRect=current.getBoundingClientRect(),currentElementX=currentElementRect.left+currentElementRect.width/2,currentElementY=currentElementRect.top+currentElementRect.height/2,currentElementCenter=new Point(currentElementX,currentElementY);"up"==direction?currentElementCenter.y=currentElementRect.top:"down"==direction?currentElementCenter.y=currentElementRect.top+currentElementRect.height:"left"==direction?currentElementCenter.x=currentElementRect.left:"right"==direction&&(currentElementCenter.x=currentElementRect.left+currentElementRect.width);for(var i=0;i<navElements.length;i++){var el=navElements[i],isHidden=null==el.offsetParent,isCurrent=navElements.indexOf(current)==i,inDOM=document.body.contains(el);if(!isHidden&&!isCurrent&&inDOM){var elementRect=el.getBoundingClientRect(),elementCenterX=elementRect.left+elementRect.width/2,elementCenterY=elementRect.top+elementRect.height/2,elementCenter=new Point(elementCenterX,elementCenterY),elementDistance=getDistance(currentElementCenter,elementCenter),angle=getAngle(currentElementCenter,elementCenter);0>angle&&(angle+=360);var inFOV=!1;"left"==direction&&(angle>360-halfFOV&&360>=angle||angle>=0&&0+halfFOV>angle)?inFOV=!0:"down"==direction&&angle>270-halfFOV&&270+halfFOV>angle?inFOV=!0:"right"==direction&&angle>180-halfFOV&&180+halfFOV>angle?inFOV=!0:"up"==direction&&angle>90-halfFOV&&90+halfFOV>angle&&(inFOV=!0);var endPoint,line,x1=elementRect.left,x2=elementRect.left+elementRect.width,y1=elementRect.top,y2=elementRect.top+elementRect.height,intersections=[];"up"==direction?(line={start:new Point(x1,y2),end:new Point(x2,y2)},endPoint=new Point(currentElementCenter.x,0)):"down"==direction?(line={start:new Point(x1,y1),end:new Point(x2,y1)},endPoint=new Point(currentElementCenter.x,windowSize.height)):"left"==direction?(line={start:new Point(x2,y1),end:new Point(x2,y2)},endPoint=new Point(0,currentElementCenter.y)):"right"==direction&&(line={start:new Point(x1,y1),end:new Point(x1,y2)},endPoint=new Point(windowSize.width,currentElementCenter.y));var intersection=getIntersection(endPoint,currentElementCenter,line.start,line.end);intersection&&(elementDistance=getDistance(currentElementCenter,intersection),intersections.push(intersection)),(inFOV||intersections.length)&&(null===distance||distance>elementDistance)&&(distance=elementDistance,index=i)}}if("undefined"==typeof index)return!1;var nextElement=navElements[index];return scroll(this.element,nextElement),nextElement};var nav=new Nav;window.navigation=function(){return nav.initialize()}()}();